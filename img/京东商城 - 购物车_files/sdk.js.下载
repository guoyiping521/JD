!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):(t=t||self).Watchtower=e()}(this,function(){"use strict";var n=function(t,e){return(n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r])})(t,e)};function t(t,e){function r(){this.constructor=t}n(t,e),t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)}var v=function(){return(v=Object.assign||function(t){for(var e,r=1,n=arguments.length;r<n;r++)for(var o in e=arguments[r])Object.prototype.hasOwnProperty.call(e,o)&&(t[o]=e[o]);return t}).apply(this,arguments)};function y(t,e){var r={};for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&e.indexOf(n)<0&&(r[n]=t[n]);if(null!=t&&"function"==typeof Object.getOwnPropertySymbols){var o=0;for(n=Object.getOwnPropertySymbols(t);o<n.length;o++)e.indexOf(n[o])<0&&Object.prototype.propertyIsEnumerable.call(t,n[o])&&(r[n[o]]=t[n[o]])}return r}var o,a=!1,s=function(){for(var t,e=[],r=0;r<arguments.length;r++)e[r]=arguments[r];return a&&window.console&&(t=window.console).info.apply(t,e)},c=function(){for(var t,e=[],r=0;r<arguments.length;r++)e[r]=arguments[r];return a&&window.console&&(t=window.console).warn.apply(t,e)},e=(t(r,o=Error),r);function r(t){var e=this.constructor,r=o.call(this,t)||this;return r.message=t,r.name=e.prototype.constructor.name,Object.setPrototypeOf(r,e.prototype),r}var i=(u.prototype.send=function(t){throw new e("请勿直接使用 BaseTransport 上报")},u);function u(t){this.endpoint=t}var l,p=(t(f,l=i),f.prototype.send=function(t){var e=new XMLHttpRequest;e.open("POST",this.endpoint),e.setRequestHeader("Content-Type","application/json"),e.send(JSON.stringify(v({},t)))},f.prototype.wtAjax=function(n){var o=this;return new Promise(function(t,e){XMLHttpRequest||e("不支持低版本浏览器哦");var r=new XMLHttpRequest;r.open("POST",o.endpoint,!0),r.setRequestHeader("Content-Type","application/json"),r.send(JSON.stringify(n)),r.onreadystatechange=function(){4===r.readyState&&(200===r.status?t(JSON.parse(r.responseText)):e(r))}})},f);function f(){return null!==l&&l.apply(this,arguments)||this}var d,h=(t(w,d=i),w.prototype.send=function(t){var e=new Blob([JSON.stringify(v({},t))],{type:"text/plain; charset=UTF-8"});window.navigator.sendBeacon(this.endpoint,e)},w);function w(){return null!==d&&d.apply(this,arguments)||this}var _="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{};function m(t){return t&&t.__esModule&&Object.prototype.hasOwnProperty.call(t,"default")?t.default:t}function b(t,e){return t(e={exports:{}},e.exports),e.exports}var g=b(function(t,e){var r;Object.defineProperty(e,"__esModule",{value:!0}),(r=e.BreadcrumbType||(e.BreadcrumbType={})).XHR="XHR",r.CONSOLE="CONSOLE",r.UI_CLICK="UI.CLICK",r.NAVIGATION="NAVIGATION",r.FETCH="FETCH"});m(g);g.BreadcrumbType;var O=b(function(t,e){var r;Object.defineProperty(e,"__esModule",{value:!0}),(r=e.WatchtowerEventType||(e.WatchtowerEventType={})).ECMASCRIPT_ERROR="ECMASCRIPT_ERROR",r.XHR_ERROR="XHR_ERROR",r.RESOURCE_ERROR="RESOURCE_ERROR",r.JSONP_ERROR="JSONP_ERROR",r.UNHANDLEDREJECTION="UNHANDLEDREJECTION",r.LOW_FPS="LOW_FPS",r.PAGE_CRASH="PAGE_CRASH",r.DO_NOT_USE="DO_NOT_USE",r.SLOW_INTERFACE_RESPONSE="SLOW_INTERFACE_RESPONSE",r.FETCH_ERROR="FETCH_ERROR",r.CUSTOM="CUSTOM"});m(O);O.WatchtowerEventType;var E=b(function(t,r){function e(t){for(var e in t)r.hasOwnProperty(e)||(r[e]=t[e])}Object.defineProperty(r,"__esModule",{value:!0}),e(g),e(O)});m(E);var R=E.BreadcrumbType,S=E.WatchtowerEventType;function j(){if(function(){if("fetch"in window)try{return new Headers,new Request(""),new Response,1}catch(t){return}}())try{return-1!==window.fetch.toString().indexOf("native")}catch(t){return}}function T(){this.__data__=[],this.size=0}var x=function(t,e){return t===e||t!=t&&e!=e};var C=function(t,e){for(var r=t.length;r--;)if(x(t[r][0],e))return r;return-1},I=Array.prototype.splice;function P(t){var e=this.__data__,r=C(e,t);return!(r<0)&&(r==e.length-1?e.pop():I.call(e,r,1),--this.size,!0)}function L(t){var e=this.__data__,r=C(e,t);return r<0?void 0:e[r][1]}function H(t){return-1<C(this.__data__,t)}function N(t,e){var r=this.__data__,n=C(r,t);return n<0?(++this.size,r.push([t,e])):r[n][1]=e,this}function A(t){var e=-1,r=null==t?0:t.length;for(this.clear();++e<r;){var n=t[e];this.set(n[0],n[1])}}A.prototype.clear=T,A.prototype.delete=P,A.prototype.get=L,A.prototype.has=H,A.prototype.set=N;var U=A;function D(){this.__data__=new U,this.size=0}function F(t){var e=this.__data__,r=e.delete(t);return this.size=e.size,r}function B(t){return this.__data__.get(t)}function M(t){return this.__data__.has(t)}var k="object"==typeof _&&_&&_.Object===Object&&_,z="object"==typeof self&&self&&self.Object===Object&&self,q=k||z||Function("return this")(),J=q.Symbol,W=Object.prototype,G=W.hasOwnProperty,X=W.toString,$=J?J.toStringTag:void 0;var V=function(t){var e=G.call(t,$),r=t[$];try{var n=!(t[$]=void 0)}catch(t){}var o=X.call(t);return n&&(e?t[$]=r:delete t[$]),o},K=Object.prototype.toString;var Y=function(t){return K.call(t)},Q=J?J.toStringTag:void 0;var Z=function(t){return null==t?void 0===t?"[object Undefined]":"[object Null]":(Q&&Q in Object(t)?V:Y)(t)};var tt=function(t){var e=typeof t;return null!=t&&("object"==e||"function"==e)};var et,rt=function(t){if(!tt(t))return!1;var e=Z(t);return"[object Function]"==e||"[object GeneratorFunction]"==e||"[object AsyncFunction]"==e||"[object Proxy]"==e},nt=q["__core-js_shared__"],ot=(et=/[^.]+$/.exec(nt&&nt.keys&&nt.keys.IE_PROTO||""))?"Symbol(src)_1."+et:"";var at=function(t){return!!ot&&ot in t},it=Function.prototype.toString;var ct=function(t){if(null!=t){try{return it.call(t)}catch(t){}try{return t+""}catch(t){}}return""},st=/^\[object .+?Constructor\]$/,ut=Function.prototype,lt=Object.prototype,pt=ut.toString,ft=lt.hasOwnProperty,dt=RegExp("^"+pt.call(ft).replace(/[\\^$.*+?()[\]{}|]/g,"\\$&").replace(/hasOwnProperty|(function).*?(?=\\\()| for .+?(?=\\\])/g,"$1.*?")+"$");var ht=function(t){return!(!tt(t)||at(t))&&(rt(t)?dt:st).test(ct(t))};var vt=function(t,e){return null==t?void 0:t[e]};var wt=function(t,e){var r=vt(t,e);return ht(r)?r:void 0},_t=wt(q,"Map"),yt=wt(Object,"create");function mt(){this.__data__=yt?yt(null):{},this.size=0}function bt(t){var e=this.has(t)&&delete this.__data__[t];return this.size-=e?1:0,e}var gt=Object.prototype.hasOwnProperty;function Ot(t){var e=this.__data__;if(yt){var r=e[t];return"__lodash_hash_undefined__"===r?void 0:r}return gt.call(e,t)?e[t]:void 0}var Et=Object.prototype.hasOwnProperty;function Rt(t){var e=this.__data__;return yt?void 0!==e[t]:Et.call(e,t)}function St(t,e){var r=this.__data__;return this.size+=this.has(t)?0:1,r[t]=yt&&void 0===e?"__lodash_hash_undefined__":e,this}function jt(t){var e=-1,r=null==t?0:t.length;for(this.clear();++e<r;){var n=t[e];this.set(n[0],n[1])}}jt.prototype.clear=mt,jt.prototype.delete=bt,jt.prototype.get=Ot,jt.prototype.has=Rt,jt.prototype.set=St;var Tt=jt;var xt=function(t){var e=typeof t;return"string"==e||"number"==e||"symbol"==e||"boolean"==e?"__proto__"!==t:null===t};var Ct=function(t,e){var r=t.__data__;return xt(e)?r["string"==typeof e?"string":"hash"]:r.map};function It(t){var e=Ct(this,t).delete(t);return this.size-=e?1:0,e}function Pt(t){return Ct(this,t).get(t)}function Lt(t){return Ct(this,t).has(t)}function Ht(t,e){var r=Ct(this,t),n=r.size;return r.set(t,e),this.size+=r.size==n?0:1,this}function Nt(t){var e=-1,r=null==t?0:t.length;for(this.clear();++e<r;){var n=t[e];this.set(n[0],n[1])}}Nt.prototype.clear=function(){this.size=0,this.__data__={hash:new Tt,map:new(_t||U),string:new Tt}},Nt.prototype.delete=It,Nt.prototype.get=Pt,Nt.prototype.has=Lt,Nt.prototype.set=Ht;var At=Nt;function Ut(t,e){var r=this.__data__;if(r instanceof U){var n=r.__data__;if(!_t||n.length<199)return n.push([t,e]),this.size=++r.size,this;r=this.__data__=new At(n)}return r.set(t,e),this.size=r.size,this}function Dt(t){var e=this.__data__=new U(t);this.size=e.size}Dt.prototype.clear=D,Dt.prototype.delete=F,Dt.prototype.get=B,Dt.prototype.has=M,Dt.prototype.set=Ut;var Ft=Dt,Bt=function(){try{var t=wt(Object,"defineProperty");return t({},"",{}),t}catch(t){}}();var Mt=function(t,e,r){"__proto__"==e&&Bt?Bt(t,e,{configurable:!0,enumerable:!0,value:r,writable:!0}):t[e]=r};var kt=function(t,e,r){(void 0===r||x(t[e],r))&&(void 0!==r||e in t)||Mt(t,e,r)};var zt=function(s){return function(t,e,r){for(var n=-1,o=Object(t),a=r(t),i=a.length;i--;){var c=a[s?i:++n];if(!1===e(o[c],c,o))break}return t}}(),qt=b(function(t,e){var r=e&&!e.nodeType&&e,n=r&&t&&!t.nodeType&&t,o=n&&n.exports===r?q.Buffer:void 0,a=o?o.allocUnsafe:void 0;t.exports=function(t,e){if(e)return t.slice();var r=t.length,n=a?a(r):new t.constructor(r);return t.copy(n),n}}),Jt=q.Uint8Array;var Wt=function(t){var e=new t.constructor(t.byteLength);return new Jt(e).set(new Jt(t)),e};var Gt=function(t,e){var r=e?Wt(t.buffer):t.buffer;return new t.constructor(r,t.byteOffset,t.length)};var Xt=function(t,e){var r=-1,n=t.length;for(e=e||Array(n);++r<n;)e[r]=t[r];return e},$t=Object.create;function Vt(){}var Kt=function(t){if(!tt(t))return{};if($t)return $t(t);Vt.prototype=t;var e=new Vt;return Vt.prototype=void 0,e};var Yt=function(e,r){return function(t){return e(r(t))}},Qt=Yt(Object.getPrototypeOf,Object),Zt=Object.prototype;var te=function(t){var e=t&&t.constructor;return t===("function"==typeof e&&e.prototype||Zt)};var ee=function(t){return"function"!=typeof t.constructor||te(t)?{}:Kt(Qt(t))};var re=function(t){return null!=t&&"object"==typeof t};var ne=function(t){return re(t)&&"[object Arguments]"==Z(t)},oe=Object.prototype,ae=oe.hasOwnProperty,ie=oe.propertyIsEnumerable,ce=ne(function(){return arguments}())?ne:function(t){return re(t)&&ae.call(t,"callee")&&!ie.call(t,"callee")},se=Array.isArray;var ue=function(t){return"number"==typeof t&&-1<t&&t%1==0&&t<=9007199254740991};var le=function(t){return null!=t&&ue(t.length)&&!rt(t)};var pe=function(t){return re(t)&&le(t)};function fe(){return!1}var de=b(function(t,e){var r=e&&!e.nodeType&&e,n=r&&t&&!t.nodeType&&t,o=n&&n.exports===r?q.Buffer:void 0,a=(o?o.isBuffer:void 0)||fe;t.exports=a}),he=Function.prototype,ve=Object.prototype,we=he.toString,_e=ve.hasOwnProperty,ye=we.call(Object);var me=function(t){if(!re(t)||"[object Object]"!=Z(t))return!1;var e=Qt(t);if(null===e)return!0;var r=_e.call(e,"constructor")&&e.constructor;return"function"==typeof r&&r instanceof r&&we.call(r)==ye},be={};be["[object Float32Array]"]=be["[object Float64Array]"]=be["[object Int8Array]"]=be["[object Int16Array]"]=be["[object Int32Array]"]=be["[object Uint8Array]"]=be["[object Uint8ClampedArray]"]=be["[object Uint16Array]"]=be["[object Uint32Array]"]=!0,be["[object Arguments]"]=be["[object Array]"]=be["[object ArrayBuffer]"]=be["[object Boolean]"]=be["[object DataView]"]=be["[object Date]"]=be["[object Error]"]=be["[object Function]"]=be["[object Map]"]=be["[object Number]"]=be["[object Object]"]=be["[object RegExp]"]=be["[object Set]"]=be["[object String]"]=be["[object WeakMap]"]=!1;function ge(t){return re(t)&&ue(t.length)&&!!be[Z(t)]}var Oe=function(e){return function(t){return e(t)}},Ee=b(function(t,e){var r=e&&!e.nodeType&&e,n=r&&t&&!t.nodeType&&t,o=n&&n.exports===r&&k.process,a=function(){try{var t=n&&n.require&&n.require("util").types;return t?t:o&&o.binding&&o.binding("util")}catch(t){}}();t.exports=a}),Re=Ee&&Ee.isTypedArray,Se=Re?Oe(Re):ge;var je=function(t,e){if("__proto__"!=e)return t[e]},Te=Object.prototype.hasOwnProperty;var xe=function(t,e,r){var n=t[e];Te.call(t,e)&&x(n,r)&&(void 0!==r||e in t)||Mt(t,e,r)};var Ce=function(t,e,r,n){var o=!r;r=r||{};for(var a=-1,i=e.length;++a<i;){var c=e[a],s=n?n(r[c],t[c],c,r,t):void 0;void 0===s&&(s=t[c]),(o?Mt:xe)(r,c,s)}return r};var Ie=function(t,e){for(var r=-1,n=Array(t);++r<t;)n[r]=e(r);return n},Pe=/^(?:0|[1-9]\d*)$/;var Le=function(t,e){var r=typeof t;return!!(e=null==e?9007199254740991:e)&&("number"==r||"symbol"!=r&&Pe.test(t))&&-1<t&&t%1==0&&t<e},He=Object.prototype.hasOwnProperty;var Ne=function(t,e){var r=se(t),n=!r&&ce(t),o=!r&&!n&&de(t),a=!r&&!n&&!o&&Se(t),i=r||n||o||a,c=i?Ie(t.length,String):[],s=c.length;for(var u in t)!e&&!He.call(t,u)||i&&("length"==u||o&&("offset"==u||"parent"==u)||a&&("buffer"==u||"byteLength"==u||"byteOffset"==u)||Le(u,s))||c.push(u);return c};var Ae=function(t){var e=[];if(null!=t)for(var r in Object(t))e.push(r);return e},Ue=Object.prototype.hasOwnProperty;var De=function(t){if(!tt(t))return Ae(t);var e=te(t),r=[];for(var n in t)("constructor"!=n||!e&&Ue.call(t,n))&&r.push(n);return r};var Fe=function(t){return le(t)?Ne(t,!0):De(t)};var Be=function(t){return Ce(t,Fe(t))};var Me=function(t,e,r,n,o,a,i){var c=je(t,r),s=je(e,r),u=i.get(s);if(u)kt(t,r,u);else{var l=a?a(c,s,r+"",t,e,i):void 0,p=void 0===l;if(p){var f=se(s),d=!f&&de(s),h=!f&&!d&&Se(s);l=s,f||d||h?l=se(c)?c:pe(c)?Xt(c):d?qt(s,!(p=!1)):h?Gt(s,!(p=!1)):[]:me(s)||ce(s)?ce(l=c)?l=Be(c):tt(c)&&!rt(c)||(l=ee(s)):p=!1}p&&(i.set(s,l),o(l,s,n,a,i),i.delete(s)),kt(t,r,l)}};var ke=function n(o,a,i,c,s){o!==a&&zt(a,function(t,e){if(tt(t))s=s||new Ft,Me(o,a,e,i,n,c,s);else{var r=c?c(je(o,e),t,e+"",o,a,s):void 0;void 0===r&&(r=t),kt(o,e,r)}},Fe)};function ze(t){return t}var qe=function(t,e,r){switch(r.length){case 0:return t.call(e);case 1:return t.call(e,r[0]);case 2:return t.call(e,r[0],r[1]);case 3:return t.call(e,r[0],r[1],r[2])}return t.apply(e,r)},Je=Math.max;var We=function(a,i,c){return i=Je(void 0===i?a.length-1:i,0),function(){for(var t=arguments,e=-1,r=Je(t.length-i,0),n=Array(r);++e<r;)n[e]=t[i+e];e=-1;for(var o=Array(i+1);++e<i;)o[e]=t[e];return o[i]=c(n),qe(a,this,o)}};var Ge=function(t){return function(){return t}},Xe=Bt?function(t,e){return Bt(t,"toString",{configurable:!0,enumerable:!1,value:Ge(e),writable:!0})}:ze,$e=Date.now;var Ve=function(r){var n=0,o=0;return function(){var t=$e(),e=16-(t-o);if(o=t,0<e){if(800<=++n)return arguments[0]}else n=0;return r.apply(void 0,arguments)}}(Xe);var Ke=function(t,e){return Ve(We(t,e,ze),t+"")};var Ye=function(t,e,r){if(!tt(r))return!1;var n=typeof e;return!!("number"==n?le(r)&&Le(e,r.length):"string"==n&&e in r)&&x(r[e],t)};var Qe=function(c){return Ke(function(t,e){var r=-1,n=e.length,o=1<n?e[n-1]:void 0,a=2<n?e[2]:void 0;for(o=3<c.length&&"function"==typeof o?(n--,o):void 0,a&&Ye(e[0],e[1],a)&&(o=n<3?void 0:o,n=1),t=Object(t);++r<n;){var i=e[r];i&&c(t,i,r,o)}return t})},Ze=Qe(function(t,e,r){ke(t,e,r)});function tr(t){try{return t instanceof Element}catch(t){return}}function er(t){return t.match(/https?:\/\/api\.m\.jd\.com\/api/)}function rr(t){return"[object Object]"===Object.prototype.toString.call(t)}var nr,or=function(t){return v({project:"",type:S.DO_NOT_USE,title:"",timestamp:(new Date).getTime(),sdk:{name:"watchtower-sensor-web",version:"0.0.1"},pageInfo:{url:"",extraInfo:{}},breadcrumbs:[],extraInfo:{}},t)},ar=/^\s*at (?:(.*?) ?\()?((?:file|https?|blob|chrome-extension|native|eval|webpack|<anonymous>|[a-z]:|\/).*?)(?::(\d+))?(?::(\d+))?\)?\s*$/i,ir=/^\s*(.*?)(?:\((.*?)\))?(?:^|@)((?:file|https?|blob|chrome|webpack|resource|moz-extension).*?:\/.*?|\[native code\]|[^@]*bundle)(?::(\d+))?(?::(\d+))?\s*$/i,cr=/^\s*at (?:((?:\[object object\])?.+) )?\(?((?:file|ms-appx|https?|webpack|blob):.*?):(\d+)(?::(\d+))?\)?\s*$/i,sr=/(\S+) line (\d+)(?: > eval line \d+)* > eval/i,ur=/\((\S*)(?::(\d+))(?::(\d+))\)/,lr="?";function pr(t,e){var r={frames:[]},n="";if(t&&t.stack){for(var o=t.stack.split("\n"),a=0,i=o.length,c=void 0,s=void 0;a<i;++a)if(c=ar.exec(o[a])){var u=c[2]&&0===c[2].indexOf("native");c[2]&&0===c[2].indexOf("eval")&&(s=ur.exec(c[2]))&&(c[2]=s[1]),r.frames.push({filename:u?null:c[2],function:c[1]||lr,lineno:c[3]?+c[3]:void 0,colno:c[4]?+c[4]:void 0})}else if(c=cr.exec(o[a]))r.frames.push({filename:c[2],function:c[1]||lr,lineno:+c[3],colno:c[4]?+c[4]:void 0});else{if(!(c=ir.exec(o[a])))continue;c[3]&&-1<c[3].indexOf(" > eval")&&(s=sr.exec(c[3]))?c[3]=s[1]:0!==a||c[5]||void 0===t.columnNumber||(r.frames[0].colno=t.columnNumber+1),r.frames.push({filename:c[3],function:c[1]||lr,lineno:c[4]?+c[4]:void 0,colno:c[5]?+c[5]:void 0})}n=t.name+": "+t.message}else{if(!e)return null;r.frames.push({filename:e.file||"",function:lr,lineno:e.lineNo,colno:e.columnNo}),e.message&&(n=e.message.replace(/^\s*uncaught /i,""))}return or({stacktrace:r,title:n,type:S.ECMASCRIPT_ERROR})}function fr(t,e,r,n,o){var a;a=t;var i=pr(o,{message:t="[object ErrorEvent]"===Object.prototype.toString.call(a)?t.message:t,file:e,lineNo:r,columnNo:n});i?(vr(i),nr&&nr.apply(window,[t,e,r,n,o])):c("Global error was dropped: ",t,e,r,n,o)}var dr=!1,hr=[],vr=function(e){hr.forEach(function(t){return t(e)})},wr=(_r.prototype.install=function(e){var t;s("GlobalHandler installed"),dr||(nr=window.onerror,window.onerror=fr,dr=!0),t=function(t){e.captureEvent(t)},hr.push(t)},_r);function _r(){}function yr(t){if(!t)return{};var e=t.match(/^(([^:\/?#]+):)?(\/\/([^\/?#]*))?([^?#]*)(\?([^#]*))?(#(.*))?$/);if(!e)return{};var r=e[6]||"",n=e[8]||"",o={};return r&&(o=r.replace(/^\?/,"").split("&").reduce(function(t,e){var r=e.split("=");return t[r[0]]=decodeURIComponent(r[1]||""),t},o)),{host:e[4],path:e[5],protocol:e[2],relative:e[5]+r+n,queryParams:o,baseUrl:t.replace(/\?[^\?]*/,"")}}function mr(t,e,r){var n=t[e];if("function"==typeof n&&!n.__watchtower__){var o=r(n);"function"==typeof o&&(o.prototype=o.prototype||{},Object.defineProperties(o,{__watchtower__:{enumerable:!1,value:!0},__watchtower_original__:{enumerable:!1,value:n}})),t[e]=o}}var br=(gr.prototype.install=function(a){if(r=window.chrome,n=r&&r.app&&r.app.runtime,c="history"in window&&!!window.history.pushState&&!!window.history.replaceState,!n&&c){var i,o=function(t,e){var r=yr(t),n=yr(e),o=yr(window.location.href);r.path||(r=o),i=e,o.protocol===n.protocol&&o.host===n.host&&(e=n.relative),o.protocol===r.protocol&&o.host===r.host&&(t=r.relative),a.addBreadcrumb({category:R.NAVIGATION,data:{from:t,to:e},timestamp:(new Date).getTime()})},e=window.onpopstate;window.onpopstate=function(t){if(o(i,window.location.href),e)return e.apply(window,[t])};var t=function(n){return function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];var r=2<t.length?t[2]:void 0;return r&&o(i,r),n.apply(this,t)}};mr(window.history,"pushState",t),mr(window.history,"replaceState",t)}var r,n,c;s("Breadcrumb integration installed")},gr);function gr(){}var Or=(Er.prototype.install=function(o){"console"in window&&["info","warn","error","log"].forEach(function(n){n in window.console&&mr(window.console,n,function(r){return function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];o.addBreadcrumb({category:R.CONSOLE,timestamp:(new Date).getTime(),data:{args:JSON.stringify(t),level:n}}),r.apply(window.console,t)}})}),s("Breadcrumb integration installed")},Er);function Er(){}function Rr(t){if(!t||!t.tagName)return"";var e=t.tagName.toLowerCase(),r=t.id?"#"+t.id:"",n="";return n=(n=t.className instanceof SVGAnimatedString?t.className.baseVal:t.className)?"."+n.split(/\s+/).join("."):"","html"===e||"body"===e?e:t.tagName.toLocaleLowerCase()+r+n}function Sr(t){var e,r=[],n=Rr(t);for(r.push(n),e=t.parentNode;e&&(n=Rr(e));)r.push(n),e=e.parentNode;return r.reverse().join(" > ")}var jr=(Tr.prototype.install=function(a){window.document.addEventListener("click",function(t){var e=(new Date).getTime(),r=t.target;if(tr(r)){var n="";try{r.outerHTML&&(n=r.outerHTML.slice(0,200))}catch(t){}var o="";try{o=Sr(r)}catch(t){}(n||o)&&a.addBreadcrumb({category:R.UI_CLICK,timestamp:e,data:{domPath:o,outerHTML:n}})}},!1),s("Breadcrumb integration installed")},Tr);function Tr(){}var xr=window.navigator.userAgent,Cr=(Ir.prototype.install=function(t){s("UserAgent installed"),t.addEventProcessor(function(t){if(!t)return null;var e=t.pageInfo||{};return e.url=e.url||window.location.href,e.extraInfo=e.extraInfo||{},e.extraInfo["User-Agent"]=xr,e.extraInfo.Referer=document.referrer,v({},t,{pageInfo:e})})},Ir);function Ir(){}var Pr=(Lr.prototype.install=function(t){s("DeviceDetect installed"),t.addEventProcessor(function(t){if(!t)return null;var e="",r=window.navigator.userAgent||"";if(r.match(/^jdapp/))for(var n=0,o=r.split(";").slice(5);n<o.length;n++){var a=o[n].split("/");"model"===a[0]&&""===e&&(e=a.slice(1).join("/"))}return""!==e&&(t.extraInfo.device=e),t})},Lr);function Lr(){}var Hr=!1,Nr=(Ar.prototype.install=function(_){Hr||(Hr=!0,window.addEventListener&&window.addEventListener("error",function(t){var e,r=!1;if(t){var n=t.target||t.srcElement;if(n&&tr(n)){var o=n.tagName.toLowerCase(),a="",i=void 0;if("script"===o){var c=(a=n.src).replace(/\?[^\?]*/,"");if(!c.match(/\.js$/)){var s=yr(a).queryParams,u=void 0===s?{}:s,l=u.functionId,p=y(u,["functionId"]);r=!0,i=er(a=c)&&l?(a=c+"?functionId="+l,p):u}}else"link"===o&&"stylesheet"===n.rel?a=n.href:"img"===o&&(a=n.src);if("string"==typeof a&&""!==a){if(_.options.resourceBlacklist&&0<_.options.resourceBlacklist.length)for(var f=0,d=_.options.resourceBlacklist;f<d.length;f++){var h=d[f];if("string"==typeof h&&-1!==a.indexOf(h))return;if(e=h,"[object RegExp]"===Object.prototype.toString.call(e)&&a.match(h))return}var v="";try{v=n.outerHTML}catch(t){}var w=or({type:S.RESOURCE_ERROR,title:"资源加载失败: "+a,errorDetail:{outerHTML:v,path:Sr(n),resource:a}});r&&(w=or({type:S.JSONP_ERROR,title:"JSONP 请求失败: "+a,errorDetail:{jsonpParams:i}})),_.captureEvent(w)}}}},!0),s("UserAgent installed"))},Ar);function Ar(){}var Ur=(Dr.prototype.install=function(t){s("VisualRegionIntegration installed"),t.addEventProcessor(function(t){if(!t)return null;var e=t.extraInfo,r=void 0===e?{}:e;return window.innerHeight&&window.innerWidth&&(r.visualResolution=window.innerWidth+"x"+window.innerHeight),window.screen&&window.screen.width&&window.screen.height&&(r.screenResolution=window.screen.width+"x"+window.screen.height),void 0!==window.scrollY&&(r.scrollY=""+window.scrollY),v({},t,{extraInfo:r})})},Dr);function Dr(){}var Fr=["uranus.jd.com"],Br=(Mr.prototype.install=function(l){s("XHRIntegration installed");var t=XMLHttpRequest.prototype;mr(t,"open",function(c){return function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];var r=(t[0]||"").toUpperCase(),n=t[1]||"";try{var o=yr(n);if(!(-1!==n.indexOf(l.options.endpoint)||o.host&&-1!==Fr.indexOf(o.host)||"GET"!==r&&"POST"!==r)){var a=o.baseUrl||"",i=o.queryParams||{};"GET"===r&&er(n)&&(a=a+"?functionId="+i.functionId,delete i.functionId),this._watchtower_xhr_={method:r,baseUrl:"GET"===r?a:n,params:"GET"===r?i:{}}}}catch(t){}return c.apply(this,t)}}),mr(t,"send",function(u){return function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];var r=t[0],c=this;try{if(this._watchtower_xhr_){var n=this._watchtower_xhr_,o=n.method,a=n.baseUrl;if("POST"===o)if("string"==typeof r)this._watchtower_xhr_.params=r;else if(er(a)&&rr(r)){this._watchtower_xhr_.baseUrl=a+"?functionId="+r.functionId,r.functionId;var i=y(r,["functionId"]);this._watchtower_xhr_.params=i}else this._watchtower_xhr_.params=Object.prototype.toString.call(r);this._watchtower_xhr_.requestBeginTime=(new Date).getTime();var s=c.onreadystatechange;c.onreadystatechange=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];if(4===c.readyState){var r=(new Date).getTime();c._watchtower_xhr_.duration=r-c._watchtower_xhr_.requestBeginTime;var n="unknown";try{n=c.status}catch(t){}if("unknown"!==(c._watchtower_xhr_.code=n)){if(300<=n&&n<400){var o=c.getResponseHeader("Location");o&&(c._watchtower_xhr_.location=o);var a="";try{a=c.getAllResponseHeaders()||""}catch(t){}l.captureEvent(or({type:S.XHR_ERROR,title:"XHR 重定向: "+c._watchtower_xhr_.baseUrl,errorDetail:{method:c._watchtower_xhr_.method,baseUrl:c._watchtower_xhr_.baseUrl,params:c._watchtower_xhr_.params,duration:c._watchtower_xhr_.duration,location:c._watchtower_xhr_.location,code:c._watchtower_xhr_.code,responseHeader:a}}))}if(400<=n){c._watchtower_xhr_.responseText=c.responseText,a="";try{a=c.getAllResponseHeaders()||""}catch(t){}l.captureEvent(or({type:S.XHR_ERROR,title:"XHR 请求失败(Code: "+c._watchtower_xhr_.code+"): "+c._watchtower_xhr_.baseUrl,errorDetail:{method:c._watchtower_xhr_.method,baseUrl:c._watchtower_xhr_.baseUrl,params:c._watchtower_xhr_.params,duration:c._watchtower_xhr_.duration,responseText:c._watchtower_xhr_.responseText,code:c._watchtower_xhr_.code,responseHeader:a}}))}}l.addBreadcrumb({category:R.XHR,timestamp:r,data:v({},c._watchtower_xhr_)})}if("function"==typeof s)try{s.apply(c,t)}catch(t){var i=pr(t);i&&l.captureEvent(i)}}}}catch(t){}return u.apply(this,t)}})},Mr);function Mr(){}var kr=Yt(Object.keys,Object),zr=Object.prototype.hasOwnProperty;var qr=function(t){if(!te(t))return kr(t);var e=[];for(var r in Object(t))zr.call(t,r)&&"constructor"!=r&&e.push(r);return e};var Jr=function(t){return(le(t)?Ne:qr)(t)},Wr=Object.prototype.hasOwnProperty,Gr=Qe(function(t,e){if(te(e)||le(e))Ce(e,Jr(e),t);else for(var r in e)Wr.call(e,r)&&xe(t,r,e[r])}),Xr=($r.prototype.install=function(h){j()?(s("FetchIntegration installed"),mr(window,"fetch",function(d){return function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];var r=t[0],c=!1,s="GET",u="",l={},n="",o="";"string"==typeof r?n=r:"Request"in global&&r instanceof Request?(n=r.url,r.method&&(s=r.method)):n=String(r),t[1]&&t[1].method&&(s=t[1].method),s=s.toUpperCase(),t[1]&&t[1].headers&&t[1].headers["Content-Type"]&&(o=t[1].headers["Content-Type"]),o=o.toLowerCase();var a=yr(n);if(n&&-1===n.indexOf(h.options.endpoint)&&a.host&&-1===Fr.indexOf(a.host)){if(c=!0,u=a.baseUrl||"",Gr(l,a.queryParams),"POST"===s&&t[1]&&t[1].body){var i=t[1].body;if(rr(i))Gr(l,i);else if("application/json"===o)try{var p=JSON.parse(i);Gr(l,p)}catch(t){}else if("application/x-www-form-urlencoded"===o)try{Gr(l,{param:i})}catch(t){}else if("string"==typeof i)try{p=JSON.parse(i),Gr(l,p)}catch(t){}}er(n)&&l.functionId&&(u=u+"?functionId="+l.functionId,delete l.functionId)}var f=(new Date).getTime();return d.apply(window,t).then(function(r){if(c){var n=[];r.headers.forEach(function(t,e){n.push({key:e,value:t})});var o=(new Date).getTime(),a=o-f,i=r.status;r.clone().text().then(function(t){if(300<=i&&i<400){var e=r.headers.get("Location");h.captureEvent(or({type:S.FETCH_ERROR,title:"Fetch 重定向: "+u,errorDetail:{method:s,baseUrl:u,params:l,duration:a,location:e,code:i,responseHeader:n}}))}else 400<=i&&h.captureEvent(or({type:S.FETCH_ERROR,title:"Fetch 请求失败(Code: "+i+"): "+u,errorDetail:{method:s,baseUrl:u,params:l,duration:a,code:i,responseText:t,responseHeader:n}}));h.addBreadcrumb({category:R.FETCH,timestamp:o,data:v({method:s,baseUrl:u,params:l,duration:a,code:i},r.ok?{}:{responseText:t},{responseHeader:n})})}).catch(function(t){})}return r}).catch(function(t){if(c){var e=(new Date).getTime(),r=e-f;h.captureEvent(or({type:S.FETCH_ERROR,title:"Fetch 请求失败(网络异常): "+u,errorDetail:{method:s,baseUrl:u,params:l,duration:r}})),h.addBreadcrumb({category:R.FETCH,timestamp:e,data:{method:s,baseUrl:u,params:l,duration:r,code:"网络异常"}})}throw t})}})):s("当前环境无原生 Fetch 支持，跳过 FetchIntegration")},$r);function $r(){}var Vr=!1,Kr=(Yr.prototype.install=function(r){Vr||(Vr=!0,window.addEventListener&&window.addEventListener("unhandledrejection",function(t){if(t.preventDefault(),t){var e=or({type:S.UNHANDLEDREJECTION,title:"Promise 请求拒绝: "+(t.reason&&t.reason.message),errorDetail:{stack:t.reason&&t.reason.stack}});r.captureEvent(e)}return!0},!0),s("Unhandledrejection installed"))},Yr);function Yr(){}var Qr=!1,Zr=(tn.prototype.install=function(t){var e=this;Qr||(this.sensor=t,this.loop(),setInterval(function(){e.isLowFPS()&&e.catchLowFPS()},1e3),Qr=!0)},tn.prototype.loop=function(){var n=this,o=performance.now(),a=0,i=performance.now(),c=function(){var t=performance.now(),e=t-i;i=t;var r=Math.round(1e3/e);a++,1e3+o<t&&(r=Math.round(1e3*a/(t-o)),a=0,o=t),n.fpsList.push(r),window.requestAnimationFrame(c)};window.requestAnimationFrame(c)},tn.prototype.catchLowFPS=function(){var e=this;this.wait||(this.wait=!0,setTimeout(function(){var t=or({type:S.LOW_FPS,title:"LowFPS: 页面卡顿告警",errorDetail:{fpsLowerList:e.fpsLowerList.shift()}});e.sensor.captureEvent(t),e.wait=!1},6e4))},tn.prototype.isLowFPS=function(){var t=0,e=[],r=this.fpsList;this.fpsList=[];for(var n=0;n<r.length;n++)if(r[n]<20?(e.push(r[n]),t++):(e=[],t=0),5<=t)return this.fpsLowerList.length<20&&this.fpsLowerList.push(e),!0;return!1},tn);function tn(){this.wait=!1,this.sensor=null,this.fpsLowerList=[],this.fpsList=[]}var en,rn=!1,nn="watchtower",on="t_crash",an="watchtower_worker",cn=(sn.prototype.install=function(i){if(!rn){try{var t=window.indexedDB.open(nn,1);t.onsuccess=function(){try{en=t.result,setTimeout(function(){if(en.objectStoreNames.contains(on)){var a=en.transaction([on]).objectStore(on).get(1);a.onsuccess=function(t){if(a.result){sn.remove();var e=a.result,r=e.title,n=e.time,o=e.memory;i.captureEvent(or({type:S.PAGE_CRASH,title:"页面崩溃: "+r,errorDetail:{time:n,jsHeapSizeLimit:o&&o.jsHeapSizeLimit,usedJSHeapSize:o&&o.usedJSHeapSize,totalJSHeapSize:o&&o.totalJSHeapSize}}))}}}},0)}catch(t){console.log(t)}},t.onupgradeneeded=function(t){(en=t&&t.target&&t.target.result).objectStoreNames.contains(on)||en.createObjectStore(on,{keyPath:"id"}).createIndex("title","title",{unique:!1})}}catch(t){}sn.createWorker(),rn=!0}},sn.remove=function(){en.transaction([on],"readwrite").objectStore(on).delete(1).onsuccess=function(){}},sn.createWorker=function(){window.onload=function(){sn.addWorkerScript(),setTimeout(function(){sn.addMainScript()},1e3)}},sn.addWorkerScript=function(){var t=document.body,e=document.createElement("script");e.type="watchtower/worker",e.id=an,e.innerHTML='\n        let db,\n        pageInfo = {};\n      onmessage = function(e) {\n        pageInfo = e.data;\n      };\n      let worker_timer = setInterval(() => {\n        if (pageInfo.time && new Date().getTime() - pageInfo.time > 6000) {\n          openDB();\n          clearInterval(worker_timer);\n        }\n      }, 2000);\n      function openDB() {\n        var request = self.indexedDB.open("'+nn+'", 1);\n        request.onsuccess = function(event) {\n          db = request.result;\n          addData();\n        };\n      }\n      function addData() {\n        const { time, title, memory } = pageInfo;\n        var request = db\n          .transaction(["'+on+'"], "readwrite")\n          .objectStore("'+on+'")\n          .add({\n            id: 1,\n            time,\n            title,\n            memory,\n          });\n      }\n    ',t.appendChild(e)},sn.addMainScript=function(){var t=document.body,e=document.createElement("script");e.type="text/javascript",e.innerHTML='\n      var blob = new Blob([\n        document.querySelector("#'+an+'").textContent,\n      ]);\n      var url = window.URL.createObjectURL(blob);\n      var worker = new Worker(url);\n      let timer = setInterval(() => {\n        const {\n          jsHeapSizeLimit,\n          usedJSHeapSize,\n          totalJSHeapSize,\n        } = window.performance.memory;\n        worker.postMessage({\n          time: new Date().getTime(),\n          title: window.location.href,\n          memory: {\n            jsHeapSizeLimit,\n            usedJSHeapSize,\n            totalJSHeapSize,\n          },\n        });\n      }, 2000);\n    ',t.appendChild(e)},sn);function sn(){}var un=[],ln={DO_NOT_USE:"",ECMASCRIPT_ERROR:"ecmaScriptError",XHR_ERROR:"xhrError",RESOURCE_ERROR:"resourceError",FETCH_ERROR:"fetchError",JSONP_ERROR:"jsonpError",UNHANDLEDREJECTION:"unhandledRejection",LOW_FPS:"lowFps",PAGE_CRASH:"pageCrash",SLOW_INTERFACE_RESPONSE:"slowInterResp",CUSTOM:"custom"},pn=null,fn=(dn.prototype.addEventProcessor=function(t){this.eventProcessors.push(t)},dn.prototype.addBreadcrumb=function(t){!this.options.reportBreadcrumb.console&&"CONSOLE"===t.category||this.findTimeoutReq(t)||(30===un.length&&un.shift(),un.push(t))},dn.prototype.findTimeoutReq=function(t){var n=this,o=!1;if(0==this.focusInters.length)return o;var e=t.category,a=t.data;return e!==R.FETCH&&e!==R.XHR||this.focusInters.some(function(t){var e=a.baseUrl.toLowerCase(),r=t.interface.toLowerCase();return-1<e.indexOf(r)&&a.duration>t.threshold&&(n.captureEvent(or({type:S.SLOW_INTERFACE_RESPONSE,title:"接口请求超时: "+a.baseUrl,errorDetail:Gr(a,{threshold:t.threshold})})),o=!0)}),o},dn.prototype.captureEvent=function(t){var e=t;this.eventProcessors.forEach(function(t){e=t(e)}),null===e?s("Event has been filtered by processor: ",t):this.transport.send(e)},dn);function dn(t){var e=this;this.focusInters=[];this.options=Ze({},{project:"",endpoint:"https://watchtower-logger.jd.com",samplingRate:1,reportErrors:{ecmaScriptError:!0,xhrError:!0,jsonpError:!0,fetchError:!0,resourceError:!0,unhandledRejection:!0,lowFps:!0,pageCrash:!1,slowInterResp:!0,custom:!0},reportBreadcrumb:{console:!1}},t),this.eventProcessors=[function(t){return t?pn&&pn.type===t.type&&pn.title===t.title?(pn=t,null):pn=t:null},function(t){return t&&Math.random()<=e.options.samplingRate?t:null},function(t){return t&&e.options.reportErrors[ln[t.type]]?t:null},function(t){return t?v({},t,{project:e.options.project}):null},function(t){return t?v({},t,{breadcrumbs:un.slice()}):null}],!function(){if(window.navigator.sendBeacon)try{return new Blob,-1!==window.navigator.sendBeacon.toString().indexOf("native")}catch(t){return}}()?this.transport=new p(this.options.endpoint+"/log"):this.transport=new h(this.options.endpoint+"/log"),(new Or).install(this),(new jr).install(this),(new br).install(this),(new wr).install(this),(new Cr).install(this),(new Pr).install(this),(new Nr).install(this),(new Ur).install(this),(new Br).install(this),(new Xr).install(this),(new Kr).install(this),(new Zr).install(this),this.options.reportErrors.pageCrash&&(new cn).install(this),new p(this.options.endpoint+"/api/getInterBySlug").wtAjax({slug:this.options.project}).then(function(t){t.isSuccess&&(e.focusInters=t.data)})}return{init:function(t){window.__watchtower_sensor__||t.project&&(window.__watchtower_sensor__=new fn(t))},catchExp:function(t){var e,r,n=t.title,o=t.errorDetail,a=t.type;n&&window.__watchtower_sensor__&&window.__watchtower_sensor__.captureEvent(or({type:(e=a,(r=new Map).set("ECMASCRIPT_ERROR",S.ECMASCRIPT_ERROR),r.set("XHR_ERROR",S.XHR_ERROR),r.set("RESOURCE_ERROR",S.RESOURCE_ERROR),r.set("UNHANDLEDREJECTION",S.UNHANDLEDREJECTION),r.set("LOW_FPS",S.LOW_FPS),r.set("PAGE_CRASH",S.PAGE_CRASH),r.set("SLOW_INTERFACE_RESPONSE",S.SLOW_INTERFACE_RESPONSE),r.set("FETCH_ERROR",S.FETCH_ERROR),r.set("CUSTOM",S.CUSTOM),e&&r.has(e)?r.get(e):S.CUSTOM),title:"自定义异常: "+n,errorDetail:"[object Object]"===Object.prototype.toString.call(o)?o:{}}))}}});
